# Spooky-AutoBuy

> Мультикомпонентная система для управления Minecraft-ботами: центральный контроллер, агенты на VPS и web‑интерфейс для мониторинга цен, переводов и логов.

## Оглавление
- [Обзор](#обзор)
- [Возможности](#возможности)
- [Структура репозитория](#структура-репозитория)
- [Требования](#требования)
- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
- [Web UI и API](#web-ui-и-api)
- [Капча и approvals](#капча-и-approvals)
- [Разработка и отладка](#разработка-и-отладка)
- [Безопасность](#безопасность)
- [Troubleshooting](#troubleshooting)

## Обзор
Проект состоит из Node.js‑контроллера и легковесного агента. Агенты подключаются к контроллеру по WebSocket (Socket.IO), запускает ботов на mineflayer, пересылают логи, баланс и события. Контроллер управляет ролями (worker/updater), служит REST API и раздаёт web‑панель (controller/webui).

В чём преимущество над другими автобаями? Мой автобай полностью автономный, ему не нужно наблюдение что бы он проработал целый вайп, он сам обновляет цены, сам покупает и продаёт предметы, расценки расчитываются по универсальной мат. формуле, не использует лишнии ресурсы, в стоке быстрее любого другого мода, либо клиента за счёт того что написан на mineflayer.

### Архитектура
- **Controller** (`controller/`) — Express + Socket.IO сервер, API, статическая выдача панели, хранилище цен и очереди approvals.
- **Agent** (`agent/index.js`) — прокси между контроллером и bot runtime, следит за процессом, крутит роль/child process, пересылает задачи.
- **Bot runtime** (`agent/botapp/`) — mineflayer‑скрипты: captcha, аукцион, мониторинг, переводы, хранение истории.
- **Web UI** (`controller/webui/`) — React/Tailwind страница для просмотра ботов, балансов, approvals и отправки команд.

## Возможности
- Централизованный мониторинг всех VPS/ботов, включая баланс и статус.
- Автоматизированный сбор цен с аукциона, расчёт buy/sell и трансляция снапшотов остальным агентам.
- Очередь approvals для запуска новых машин; whitelist в `approvedMachines.json`.
- Очередь переводов `/pay` с разбивкой задач по машинам (transfer planner).
- Встроенный логгер + проксирование чат‑команд / события капчи.
- Простая панель управления для запуска ботов, отправки переводов и ручного утверждения машин.

## Структура репозитория
```
.
├── agent/
│   ├── index.js              # родительский процесс агента
│   └── botapp/               # mineflayer-логика и модули
├── controller/
│   ├── index.js              # HTTP + Socket.IO сервер
│   └── webui/                # статический React UI
├── approvedMachines.json     # whitelist VPS
├── package.json              # зависимости
├── package-lock.json
└── README.md                 # этот файл
```

## Требования
- Node.js 18 LTS или выше (нужен встроенный `fetch`).
- npm 10+ для установки зависимостей.
- Стабильное сетевое соединение между агентами и контроллером (WebSocket).
- **Опционально:** ключ BareAPI для автосолва капчи, токен Telegram‑бота/чат для нотификаций (хук заложен в `controller/config.js`).

## Установка
1. Клонируйте репозиторий и перейдите в корень.
2. Установите зависимости один раз для всех пакетов:
   ```bash
   npm install
   ```
3. При необходимости создайте отдельные `.env`/systemd‑unit для контроллера и каждого агента.

## Конфигурация
### Переменные контроллера (`controller/config.js`)
| Переменная | По умолчанию | Назначение |
| --- | --- | --- |
| `PORT` | `4000` | Порт HTTP/Socket.IO сервера. |
| `TELEGRAM_TOKEN` | пусто | Токен Telegram‑бота для уведомлений (зарезервировано под интеграцию). |
| `TELEGRAM_CHAT_ID` | пусто | Цель для Telegram‑уведомлений. |
| `BARE_API_KEY` | пусто | Ключ BareAPI для решения капч. |

### Переменные агента/ботов
| Переменная | По умолчанию | Назначение |
| --- | --- | --- |
| `VPS_ID` | `vps-local` | Уникальный идентификатор машины. Используется в approval‑цикле и UI. |
| `CTRL_URL` | `ws://localhost:4000` | WebSocket‑адрес контроллера (меняйте на публичный URL при деплое). |
| `BOT_PASSWORD` | `4344442` | Пароль `/reg` + `/login` для всех ботов. **Обязательно переопределите через секрет.** |
| `FORCE_UPDATER` | пусто | Если `1`, агент запускает первый бот в роли price‑updater независимо от команды контроллера. |
| `SKIP_APPROVAL` | устанавливается агентом | Служебный флаг, который агент прокидывает дочернему процессу после удачного approve. |

### Данные и файлы
- `approvedMachines.json` — список доверенных `VPS_ID` (создаётся контроллером после approve).
- `priceStore.json` — слепок цен и истории (лежит рядом с корнем).
- `agent/botapp/listedItems.json` — сохранённые выставленные лоты по каждому боту.
- `agent/botapp/botname.txt` — последний никнейм, использованный при `startBotPair`.
- Логи пишутся в stdout, поэтому используйте systemd/pm2/другой supervisor для ротации.

## Запуск
1. **Контроллер** (на сервере с публичным IP):
   ```bash
   PORT=4000 BARE_API_KEY=your_key node controller/index.js
   ```
2. **Web UI** автоматически доступен по `http://<host>:<PORT>/`.
3. **Агент** (на каждой VPS; лучше заранее прописать ник в `agent/botapp/botname.txt`):
   ```bash
   VPS_ID=vps-01 CTRL_URL=wss://controller.example.com BOT_PASSWORD=secret node agent/index.js
   ```
4. После запуска агент запросит approve. Зайдите в Web UI (или вызовите `POST /api/approve`) и подтвердите машину. После попадания в whitelist агент будет перезапускать botapp автоматически.
5. Для нескольких агентов нужны отдельные папки проекта либо запуск через изолированные окружения для разделения чувствительных данных.

## Web UI и API
### Панель
- Раздаётся контроллером: `http://<controller-host>:<PORT>/`.
- Блок KPI показывает количество ботов, суммарный баланс, количество VPS и висящих approvals.
- Список ботов обновляется каждые 5 секунд и поддерживает маскирование балансов.
- Сайдбар позволяет запускать новых ботов (`/api/start`), отправлять переводы (`/api/transfer`) и утверждать pending‑машины.

### REST / Socket API
| Метод | Путь | Описание |
| --- | --- | --- |
| `GET` | `/api/agents` | Список всех подключённых агентов и их боты. |
| `GET` | `/api/price` | Текущий `priceStore`. |
| `POST` | `/api/chat` | Транслировать сообщение конкретному боту. |
| `POST` | `/api/start` | Отправить `startBotPair` на price‑updater агент. |
| `GET` | `/api/approvals` | Очередь запросов на approve. |
| `POST` | `/api/approve` | Утвердить конкретный id, добавить VPS в whitelist. |
| `POST` | `/api/transfer` | Инициировать `/pay` (акк, получатель, сумма). Контроллер сам разобьёт задачи по агентам. |
| `GET` | `/api/feed` | Получить последние события item feed. |
| `POST` | `/api/feed` | Добавить вручную запись (`id`, `price`, `sellPrice`). |

Каналы Socket.IO: `assignRole`, `transfer`, `price:broadcast`, `chat`, `captcha:*`, `approve:*`, `bots:update`.

## Капча и approvals
- Агенты отправляют base64 PNG на событие `captcha:request`; контроллер отправляет изображение в BareAPI (`BARE_API_KEY`).
- Ответ рассылается через `captcha:answer`, и бот продолжает авторизацию.
- Первичная авторизация машины: агент генерирует UUID, контроллер кладёт в `/api/approvals`. После подтверждения запись попадает в `approvedMachines.json`, и машина в дальнейшем запускается без ручного шага.

## Разработка и отладка
- Тестов нет. Рекомендуется проверять изменения на локальном стенде (контроллер + один агент) перед выкладкой.
- В `agent/botapp/modules` код разбит по зонам ответственности (auction, captcha, transfers и т.д.). Добавляйте новые сценарии как отдельные модули и подключайте их в `botapp.js`.

## Безопасность
- Не храните реальные пароли/никнеймы в репозитории. Переопределяйте `BOT_PASSWORD`, списки аккаунтов и любые секреты с помощью переменных окружения или внешних vault.
- `approvedMachines.json`, `priceStore.json` и `listedItems.json` содержат чувствительные данные.
- Web UI показывает пользовательские ники и балансы, поэтому защищайте контроллер обратным прокси + базовой авторизацией/VPN.

## Troubleshooting
- **Агент бесконечно ждёт approve.** Проверьте, попал ли `VPS_ID` в `approvedMachines.json` и нет ли дубликатов. Удалите запись, перезапустите агента и заново подтвердите.
- **Не обновляется priceStore.** Убедитесь, что хотя бы один агент получил роль updater (лог `[IO] role for ... -> updater-a`). 
- **Переводы не выполняются.** Проверьте, что у выбранных ботов достаточно средств; при нехватке `planTransfer` вернёт *insufficient funds*.
- **Капча не решается.** Посмотрите логи `[captcha]` на контроллере и обновите `BARE_API_KEY`.
